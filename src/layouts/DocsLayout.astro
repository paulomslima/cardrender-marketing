---
import BaseLayout from "./BaseLayout.astro";
import { FileText, BookOpen, Users, Palette, BarChart3, Code, Shield } from "lucide-astro";

const { title, description } = Astro.props;

const pages = [
  { label: "Getting Started", href: "/docs/getting-started", icon: FileText },
  { label: "Teams & Roles", href: "/docs/teams", icon: Users },
  { label: "Branding & Templates", href: "/docs/branding-and-templates", icon: Palette },
  { label: "Analytics", href: "/docs/analytics", icon: BarChart3 },
  { label: "Public API", href: "/docs/api", icon: Code },
  { label: "Security", href: "/docs/security", icon: Shield },
];
---

<BaseLayout title={title} description={description}>
  <div class="docs-hero">
    <div class="container">
      <div class="docs-breadcrumb">
        <a href="/">Home</a>
        <span>/</span>
        <a href="/docs">Documentation</a>
      </div>
    </div>
  </div>
  
  <section class="docs-section">
    <div class="container docs-container docs-layout">
      <aside class="docs-sidebar">
        <div class="docs-nav-header">
          <BookOpen size={20} />
          <h3>Documentation</h3>
        </div>
        <nav class="docs-nav">
          {pages.map((page) => {
            const Icon = page.icon;
            const isActive = Astro.url.pathname === page.href;
            return (
              <a class={isActive ? "active" : ""} href={page.href}>
                <Icon size={18} />
                <span>{page.label}</span>
              </a>
            );
          })}
        </nav>
      </aside>
      
      <article class="docs-content">
        <div class="docs-prose" id="docs-content">
          <slot />
        </div>
      </article>
      
      <aside class="docs-toc">
        <div class="toc-header">
          <h4>On this page</h4>
        </div>
        <nav class="toc-nav" id="toc-nav" aria-label="Table of contents">
          <ul class="toc-list" id="toc-list"></ul>
        </nav>
      </aside>
    </div>
  </section>
</BaseLayout>

<script>
  let tocObserver = null;

  function initTOC() {
    if (tocObserver) {
      tocObserver.disconnect();
      tocObserver = null;
    }

    const content = document.getElementById('docs-content');
    const tocList = document.getElementById('toc-list');
    const tocContainer = document.querySelector('.docs-toc');

    if (!content || !tocList || !tocContainer) return;

    const headings = Array.from(content.querySelectorAll('h2, h3'));

    if (headings.length === 0) {
      tocContainer.classList.add('hidden');
      return;
    }

    tocContainer.classList.remove('hidden');

    const tree = buildHeadingTree(headings);
    renderTOC(tree, tocList);
    tocObserver = setupScrollSpy(headings, tocList);
  }

  function buildHeadingTree(headings) {
    const tree = [];
    let currentSection = null;

    headings.forEach((heading, index) => {
      if (!heading.id) {
        heading.id = heading.textContent
          ?.toLowerCase()
          .trim()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-+|-+$/g, '') || `section-${index}`;
      }

      const entry = {
        id: heading.id,
        text: heading.textContent?.trim() || `Section ${index + 1}`,
        level: Number(heading.tagName.slice(1))
      };

      if (entry.level === 2) {
        currentSection = { ...entry, children: [] };
        tree.push(currentSection);
      } else if (entry.level === 3) {
        const childEntry = { id: entry.id, text: entry.text, level: entry.level };
        if (currentSection) {
          currentSection.children.push(childEntry);
        } else {
          tree.push({ ...childEntry, children: [] });
        }
      }
    });

    return tree;
  }

  function renderTOC(tree, tocList) {
    tocList.innerHTML = '';
    const fragment = document.createDocumentFragment();

    tree.forEach((node) => {
      const item = document.createElement('li');
      item.className = 'toc-item';

      const link = createLink(node.id, node.text, 'toc-link');
      item.appendChild(link);

      if (node.children && node.children.length > 0) {
        const sublist = document.createElement('ul');
        sublist.className = 'toc-sublist';

        node.children.forEach((child) => {
          const subItem = document.createElement('li');
          subItem.className = 'toc-subitem';
          const childLink = createLink(child.id, child.text, 'toc-link toc-link-nested');
          subItem.appendChild(childLink);
          sublist.appendChild(subItem);
        });

        item.appendChild(sublist);
      }

      fragment.appendChild(item);
    });

    tocList.appendChild(fragment);

    const firstLink = tocList.querySelector('.toc-link');
    setActiveLink(tocList, firstLink);
  }

  function createLink(id, text, className) {
    const link = document.createElement('a');
    link.href = `#${id}`;
    link.textContent = text;
    link.className = className;
    link.dataset.heading = id;
    link.setAttribute('aria-current', 'false');
    return link;
  }

  function setActiveLink(tocList, target) {
    if (!target) return;
    tocList.querySelectorAll('.toc-link').forEach(anchor => {
      anchor.classList.remove('active');
      anchor.setAttribute('aria-current', 'false');
    });
    target.classList.add('active');
    target.setAttribute('aria-current', 'true');
  }

  function setupScrollSpy(headings, tocList) {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        const id = entry.target.getAttribute('id');
        const link = tocList.querySelector(`a[data-heading="${id}"]`);

        if (entry.isIntersecting && id && link) {
          setActiveLink(tocList, link);
        }
      });
    }, {
      rootMargin: '-100px 0px -70% 0px'
    });

    headings.forEach(heading => observer.observe(heading));

    if (!tocList.dataset.listenerAttached) {
      tocList.addEventListener('click', (event) => {
        const target = event.target;
        if (target instanceof HTMLElement && target.matches('a[data-heading]')) {
          event.preventDefault();
          const id = target.getAttribute('data-heading');
          const heading = id ? document.getElementById(id) : null;
          if (!heading) return;
          window.scrollTo({
            top: heading.getBoundingClientRect().top + window.scrollY - 80,
            behavior: 'smooth'
          });
          setActiveLink(tocList, target);
        }
      });
      tocList.dataset.listenerAttached = 'true';
    }

    return observer;
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTOC);
  } else {
    initTOC();
  }

  document.addEventListener('astro:page-load', initTOC);
</script>

<style>
  .docs-hero {
    background: linear-gradient(135deg, hsl(var(--primary) / 0.05), hsl(var(--secondary) / 0.05));
    border-bottom: 1px solid hsl(var(--border));
    padding: 1.5rem 0;
  }
  
  .docs-breadcrumb {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: hsl(var(--muted-foreground));
  }
  
  .docs-breadcrumb a {
    color: hsl(var(--muted-foreground));
    transition: color 150ms;
  }
  
  .docs-breadcrumb a:hover {
    color: hsl(var(--primary));
  }
  
  .docs-section {
    padding: 2rem 0 4rem;
  }
  
  .docs-layout {
    display: grid;
    grid-template-columns: 220px 1fr 220px;
    gap: 3.5rem;
    align-items: start;
  }
  
  /* Sidebar Navigation */
  .docs-sidebar {
    position: sticky;
    top: 6rem;
    max-height: calc(100vh - 8rem);
    overflow-y: auto;
  }
  
  .docs-nav-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
  }
  
  .docs-nav-header h3 {
    margin: 0;
    font-size: 0.875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: hsl(var(--muted-foreground));
  }
  
  .docs-nav {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  
  .docs-nav a {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.625rem 0.75rem;
    color: hsl(var(--muted-foreground));
    font-weight: 500;
    font-size: 0.875rem;
    border-radius: 8px;
    transition: all 150ms cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .docs-nav a:hover {
    background: hsl(var(--muted) / 0.1);
    color: hsl(var(--foreground));
  }
  
  .docs-nav a.active {
    background: hsl(var(--primary) / 0.1);
    color: hsl(var(--primary));
    font-weight: 600;
  }
  
  /* Main Content */
  .docs-content {
    padding: 0;
    min-height: 60vh;
  }
  
  /* Table of Contents - shadcn-style */
  .docs-toc {
    position: sticky;
    top: 6rem;
    max-height: calc(100vh - 7rem);
    overflow-y: auto;
    background: hsl(var(--card));
    border: 1px solid hsl(var(--border));
    border-radius: 14px;
    padding: 0.9rem 0.9rem 1.1rem;
    box-shadow: 0 10px 28px hsl(var(--foreground) / 0.05);
    transition: opacity 150ms ease;
  }
  
  .docs-toc.hidden {
    display: none;
  }
  
  .toc-header {
    margin-bottom: 1rem;
    padding-bottom: 0.875rem;
    border-bottom: 1px solid hsl(var(--border));
  }
  
  .toc-header h4 {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: hsl(var(--muted-foreground));
    margin: 0;
  }
  
  .toc-nav {
    margin-top: 0.5rem;
  }
  
  .toc-list {
    list-style: none;
    margin: 0;
    padding: 0 0 0 0.85rem;
    position: relative;
  }
  
  .toc-list::before {
    content: '';
    position: absolute;
    top: 0.5rem;
    bottom: 0.5rem;
    left: 0.35rem;
    width: 2px;
    background: linear-gradient(180deg, hsl(var(--border)), transparent 85%);
    border-radius: 2px;
  }
  
  .toc-item {
    margin: 0;
    padding: 0;
  }
  
  .toc-link {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.32rem 0.5rem 0.32rem 0.5rem;
    color: hsl(var(--muted-foreground));
    font-size: 0.7rem;
    font-weight: 500;
    border-radius: 0.5rem;
    position: relative;
    transition: color 150ms ease, background 150ms ease;
    text-decoration: none;
  }
  
  .toc-link::before {
    content: '';
    width: 0.42rem;
    height: 0.42rem;
    border-radius: 999px;
    border: 2px solid hsl(var(--border));
    background: hsl(var(--card));
    flex-shrink: 0;
    box-shadow: 0 0 0 4px hsl(var(--card));
  }
  
  .toc-link:hover {
    color: hsl(var(--foreground));
    background: hsl(var(--muted) / 0.12);
  }
  
  .toc-link.active {
    color: hsl(var(--primary));
    background: hsl(var(--primary) / 0.12);
  }
  
  .toc-link.active::before {
    border-color: hsl(var(--primary));
    background: hsl(var(--primary));
    box-shadow: 0 0 0 4px hsl(var(--primary) / 0.25);
  }
  
  .toc-sublist {
    list-style: none;
    margin: 0.15rem 0 0.45rem 1rem;
    padding: 0.15rem 0 0 0.7rem;
    border-left: 1px dashed hsl(var(--border));
  }
  
  .toc-subitem {
    margin: 0;
    padding: 0;
  }
  
  .toc-link-nested {
    font-size: 0.64rem;
    padding-left: 0.35rem;
  }
  
  .toc-link-nested::before {
    width: 0.4rem;
    height: 0.4rem;
    border-width: 1px;
  }
  
  /* Responsive */
  @media (max-width: 1280px) {
    .docs-layout {
      grid-template-columns: 200px 1fr;
      gap: 2.5rem;
    }
    
    .docs-toc {
      display: none;
    }
  }
  
  @media (max-width: 900px) {
    .docs-layout {
      grid-template-columns: 1fr;
      gap: 2rem;
    }
    
    .docs-sidebar {
      position: static;
      max-height: none;
      background: hsl(var(--card));
      border: 1px solid hsl(var(--border));
      border-radius: 12px;
      padding: 1.25rem;
    }
    
    .docs-content {
      padding: 0;
    }
  }
  
  @media (max-width: 640px) {
    .docs-hero {
      padding: 1rem 0;
    }
    
    .docs-section {
      padding: 1.5rem 0 3rem;
    }
    
    .docs-sidebar {
      padding: 1rem;
      border-radius: 8px;
    }
  }
</style>

