---
import BaseLayout from "./BaseLayout.astro";
import { FileText, BookOpen, Users, Palette, BarChart3, Code, Shield } from "lucide-astro";

const { title, description } = Astro.props;

const pages = [
  { label: "Getting Started", href: "/docs/getting-started", icon: FileText },
  { label: "Teams & Roles", href: "/docs/teams", icon: Users },
  { label: "Branding & Templates", href: "/docs/branding-and-templates", icon: Palette },
  { label: "Analytics", href: "/docs/analytics", icon: BarChart3 },
  { label: "Public API", href: "/docs/api", icon: Code },
  { label: "Security", href: "/docs/security", icon: Shield },
];
---

<BaseLayout title={title} description={description}>
  <div class="docs-hero">
    <div class="container">
      <div class="docs-breadcrumb">
        <a href="/">Home</a>
        <span>/</span>
        <a href="/docs">Documentation</a>
      </div>
    </div>
  </div>
  
  <section class="docs-section">
    <div class="container docs-container docs-layout">
      <aside class="docs-sidebar">
        <div class="docs-nav-header">
          <BookOpen size={20} />
          <h3>Documentation</h3>
        </div>
        <nav class="docs-nav">
          {pages.map((page) => {
            const Icon = page.icon;
            const isActive = Astro.url.pathname === page.href;
            return (
              <a class={isActive ? "active" : ""} href={page.href}>
                <Icon size={18} />
                <span>{page.label}</span>
              </a>
            );
          })}
        </nav>
      </aside>
      
      <article class="docs-content">
        <slot />
      </article>
      
      <aside class="docs-toc">
        <div class="toc-header">
          <h4>On this page</h4>
        </div>
        <nav class="toc-nav" id="toc-nav">
          <!-- Will be populated by JavaScript -->
        </nav>
      </aside>
    </div>
  </section>
</BaseLayout>

<script>
  // Generate table of contents from headings
  function generateTOC() {
    const content = document.querySelector('.docs-content');
    const tocNav = document.getElementById('toc-nav');
    
    if (!content || !tocNav) return;
    
    const headings = content.querySelectorAll('h2, h3');
    
    if (headings.length === 0) {
      tocNav.parentElement?.style.setProperty('display', 'none');
      return;
    }
    
    const headingElements: Element[] = [];
    
    headings.forEach((heading, index) => {
      // Add ID to heading if it doesn't have one
      if (!heading.id) {
        heading.id = heading.textContent
          ?.toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/(^-|-$)/g, '') || `heading-${index}`;
      }
      
      headingElements.push(heading);
      
      const link = document.createElement('a');
      link.href = `#${heading.id}`;
      link.textContent = heading.textContent || '';
      link.className = heading.tagName === 'H2' ? 'toc-link' : 'toc-link toc-link-sub';
      link.dataset.headingId = heading.id;
      
      // Smooth scroll to section
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const targetHeading = document.getElementById(heading.id);
        if (targetHeading) {
          targetHeading.scrollIntoView({ behavior: 'smooth', block: 'start' });
          window.history.replaceState(null, '', `#${heading.id}`);
        }
      });
      
      tocNav.appendChild(link);
    });
    
    // Better scroll spy implementation
    let activeId: string | null = null;
    
    function updateActiveHeading() {
      const scrollY = window.scrollY;
      const windowHeight = window.innerHeight;
      
      // Find the heading that's currently in view
      let currentId: string | null = null;
      
      for (let i = headingElements.length - 1; i >= 0; i--) {
        const heading = headingElements[i] as HTMLElement;
        const rect = heading.getBoundingClientRect();
        
        // Check if heading is in the upper portion of viewport
        if (rect.top <= 150) {
          currentId = heading.id;
          break;
        }
      }
      
      // Only update if changed
      if (currentId !== activeId) {
        activeId = currentId;
        const links = tocNav.querySelectorAll('a');
        links.forEach(link => {
          if (link.dataset.headingId === currentId) {
            link.classList.add('active');
          } else {
            link.classList.remove('active');
          }
        });
      }
    }
    
    // Throttle scroll events for performance
    let ticking = false;
    window.addEventListener('scroll', () => {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          updateActiveHeading();
          ticking = false;
        });
        ticking = true;
      }
    }, { passive: true });
    
    // Initial check
    updateActiveHeading();
    
    // Check on hash change
    window.addEventListener('hashchange', updateActiveHeading);
  }
  
  // Run on page load
  document.addEventListener('DOMContentLoaded', generateTOC);
</script>

<style>
  .docs-hero {
    background: linear-gradient(135deg, hsl(var(--primary) / 0.05), hsl(var(--secondary) / 0.05));
    border-bottom: 1px solid hsl(var(--border));
    padding: 1.5rem 0;
  }
  
  .docs-breadcrumb {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: hsl(var(--muted-foreground));
  }
  
  .docs-breadcrumb a {
    color: hsl(var(--muted-foreground));
    transition: color 150ms;
  }
  
  .docs-breadcrumb a:hover {
    color: hsl(var(--primary));
  }
  
  .docs-section {
    padding: 2rem 0 4rem;
  }
  
  .docs-layout {
    display: grid;
    grid-template-columns: 220px 1fr 220px;
    gap: 3.5rem;
    align-items: start;
  }
  
  /* Sidebar Navigation */
  .docs-sidebar {
    position: sticky;
    top: 6rem;
    max-height: calc(100vh - 8rem);
    overflow-y: auto;
  }
  
  .docs-nav-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
  }
  
  .docs-nav-header h3 {
    margin: 0;
    font-size: 0.875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: hsl(var(--muted-foreground));
  }
  
  .docs-nav {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  
  .docs-nav a {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.625rem 0.75rem;
    color: hsl(var(--muted-foreground));
    font-weight: 500;
    font-size: 0.875rem;
    border-radius: 8px;
    transition: all 150ms cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .docs-nav a:hover {
    background: hsl(var(--muted) / 0.1);
    color: hsl(var(--foreground));
  }
  
  .docs-nav a.active {
    background: hsl(var(--primary) / 0.1);
    color: hsl(var(--primary));
    font-weight: 600;
  }
  
  /* Main Content */
  .docs-content {
    padding: 0;
    min-height: 60vh;
  }
  
  /* Table of Contents */
  .docs-toc {
    position: sticky;
    top: 6rem;
    max-height: calc(100vh - 8rem);
    overflow-y: auto;
  }
  
  .toc-header {
    margin-bottom: 1rem;
  }
  
  .toc-header h4 {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: hsl(var(--muted-foreground));
    margin: 0;
  }
  
  .toc-nav {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .toc-link {
    display: block;
    font-size: 0.8125rem;
    color: hsl(var(--muted-foreground));
    padding: 0.375rem 0 0.375rem 0.875rem;
    border-left: 2px solid hsl(var(--border) / 0.3);
    margin-bottom: 0.125rem;
    transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
    line-height: 1.4;
  }
  
  .toc-link:hover {
    color: hsl(var(--foreground));
    border-left-color: hsl(var(--primary) / 0.5);
    padding-left: 1rem;
  }
  
  .toc-link.active {
    color: hsl(var(--primary));
    border-left-color: hsl(var(--primary));
    font-weight: 600;
    padding-left: 1rem;
    background: hsl(var(--primary) / 0.04);
    margin-left: -0.125rem;
    padding-right: 0.5rem;
    border-radius: 0 0.375rem 0.375rem 0;
  }
  
  .toc-link-sub {
    padding-left: 1.5rem;
    font-size: 0.75rem;
  }
  
  .toc-link-sub.active {
    padding-left: 1.625rem;
  }
  
  /* Responsive */
  @media (max-width: 1280px) {
    .docs-layout {
      grid-template-columns: 200px 1fr;
      gap: 2.5rem;
    }
    
    .docs-toc {
      display: none;
    }
  }
  
  @media (max-width: 900px) {
    .docs-layout {
      grid-template-columns: 1fr;
      gap: 2rem;
    }
    
    .docs-sidebar {
      position: static;
      max-height: none;
      background: hsl(var(--card));
      border: 1px solid hsl(var(--border));
      border-radius: 12px;
      padding: 1.25rem;
    }
    
    .docs-content {
      padding: 0;
    }
  }
  
  @media (max-width: 640px) {
    .docs-hero {
      padding: 1rem 0;
    }
    
    .docs-section {
      padding: 1.5rem 0 3rem;
    }
    
    .docs-sidebar {
      padding: 1rem;
      border-radius: 8px;
    }
  }
</style>

