---
import BaseLayout from "../layouts/BaseLayout.astro";
import { fetchPlans, formatPrice } from "../lib/plans";
import { APP_URL } from "../lib/config";

export const prerender = false;

const { plans, error } = await fetchPlans();

const activePlans = plans
  .filter((plan) => plan.isActive)
  .sort((a, b) => (a.displayOrder ?? 0) - (b.displayOrder ?? 0));

const mostPopularId = "professional";

const toLimit = (value: number | null, suffix: string) => {
  if (value === null) return `Custom ${suffix}`;
  if (value === -1) return `Unlimited ${suffix}`;
  return `${value} ${suffix}`;
};

const jsonLd = {
  "@context": "https://schema.org",
  "@type": "Product",
  name: "Cardrender",
  description: "Digital business cards, email signatures, and team identity management for modern companies.",
  offers: activePlans.map((plan) => ({
    "@type": "Offer",
    name: plan.name,
    priceCurrency: "USD",
    price: plan.monthlyPriceCents ? plan.monthlyPriceCents / 100 : 0,
    availability: "https://schema.org/InStock",
  })),
};
---

<BaseLayout
  title="Pricing"
  description="Flexible plans for teams of every size. Compare features and choose the Cardrender plan that fits your organization."
  jsonLd={jsonLd}
>
  <section class="section">
    <div class="container pricing-hero">
      <div>
        <span class="eyebrow">Pricing</span>
        <h1>Plans built for modern teams</h1>
        <p class="muted">
          Choose a plan that matches your scale. Upgrade anytime as your team grows.
        </p>
      </div>
      <div class="card pricing-highlight">
        <h3>Need enterprise support?</h3>
        <p class="muted">
          Talk with our team about SSO, custom security reviews, and tailored onboarding.
        </p>
        <a class="button secondary" href={`${APP_URL}/register`}>Contact sales</a>
      </div>
    </div>
  </section>

  <section class="section">
    <div class="container">
      {error && (
        <div class="card">
          <p>{error}. Please refresh or contact support.</p>
        </div>
      )}
      {!error && (
        <div class="grid three pricing-grid">
          {activePlans.map((plan) => (
            <div class={`card pricing-card ${plan.id === mostPopularId ? "popular" : ""}`}>
              {plan.id === mostPopularId && <span class="pill">Most popular</span>}
              <h3>{plan.name}</h3>
              <p class="muted">{plan.description ?? "Build a consistent digital presence for your team."}</p>
              <div class="price-row">
                <span class="price">{formatPrice(plan.monthlyPriceCents)}</span>
                <span class="muted">/month</span>
              </div>
              <a class="button primary" href={`${APP_URL}/register`}>Start with {plan.name}</a>
              <ul class="plan-features">
                <li>{toLimit(plan.maxSeats, "team members")}</li>
                <li>{toLimit(plan.maxCards, "cards per user")}</li>
                <li>{toLimit(plan.maxSignatures, "signatures")}</li>
                <li>{plan.premiumTemplates ? "Premium templates" : "Core templates"}</li>
                <li>{plan.customDomain ? "Custom domain support" : "Cardrender subdomain"}</li>
                <li>{plan.analyticsEnabled ? "Analytics included" : "Analytics on request"}</li>
                <li>{plan.apiAccess ? "API access" : "Standard integrations"}</li>
                <li>{plan.prioritySupport ? "Priority support" : "Standard support"}</li>
              </ul>
            </div>
          ))}
        </div>
      )}
    </div>
  </section>

  <section class="section">
    <div class="container">
      <div class="section-header">
        <span class="eyebrow">Included</span>
        <h2>Everything you need to roll out at scale</h2>
        <p class="muted">
          Every plan includes team management, branded templates, and secure sharing.
        </p>
      </div>
      <div class="grid three">
        {[
          "Team directory and member management",
          "Customizable card templates",
          "Email signature builder",
          "QR code sharing and wallet passes",
          "Workspace analytics dashboard",
          "Role-based access controls",
        ].map((item) => (
          <div class="card">{item}</div>
        ))}
      </div>
    </div>
  </section>

  <section class="section">
    <div class="container">
      <div class="section-header">
        <span class="eyebrow">FAQ</span>
        <h2>Pricing questions</h2>
      </div>
      <div class="grid three">
        <div class="card">
          <h3>Can I change plans later?</h3>
          <p class="muted">Yes. You can upgrade or downgrade at any time from the admin dashboard.</p>
        </div>
        <div class="card">
          <h3>Do you offer custom onboarding?</h3>
          <p class="muted">Enterprise customers receive onboarding, migration support, and rollout planning.</p>
        </div>
        <div class="card">
          <h3>Is there a free trial?</h3>
          <p class="muted">Every new workspace starts with a free trial, no credit card required.</p>
        </div>
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  .pricing-hero {
    display: grid;
    gap: 2rem;
    align-items: center;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  }
  .pricing-highlight {
    display: grid;
    gap: 1rem;
  }
  .pricing-grid {
    align-items: stretch;
  }
  .pricing-card {
    display: grid;
    gap: 1rem;
  }
  .pricing-card.popular {
    border: 2px solid var(--accent);
  }
  .price-row {
    display: flex;
    align-items: baseline;
    gap: 0.4rem;
  }
  .price {
    font-size: 2.2rem;
    font-weight: 700;
  }
  .plan-features {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    gap: 0.5rem;
  }
  .plan-features li::before {
    content: "â€¢";
    color: var(--accent);
    margin-right: 0.5rem;
  }
</style>
